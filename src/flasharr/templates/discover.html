{% extends "base.html" %}

{% block title %}Discover - Fshare Nexus{% endblock %}

{% block header_content %}
<div style="display: flex; gap: 1rem; align-items: center; width: 100%;">
    <div style="flex: 1; position: relative;">
        <span class="material-icons"
            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">search</span>
        <input type="text" id="tmdb-search-input" placeholder="Search Movies & TV Series..."
            style="width: 100%; height: 40px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding-left: 40px; color: white; outline: none; transition: border-color 0.2s;">
    </div>
</div>
{% endblock %}

{% block content %}
<div class="discover-container" style="padding: 1.5rem;">
    <!-- Featured / Trending -->
    <div id="discover-hero" style="margin-bottom: 2rem;">
        <h2 class="section-title" style="margin-bottom: 1rem; font-size: 1.5rem;">Trending Now</h2>
        <div id="trending-grid" class="search-results-grid">
            <!-- Trending items injected here -->
            <div class="loading-state">
                <span class="material-icons spinning">refresh</span>
                <p>Loading trending content...</p>
            </div>
        </div>
    </div>

    <!-- Search Results (Typically hidden until search) -->
    <div id="search-results-section" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 class="section-title" style="font-size: 1.5rem;">Search Results</h2>
            <button id="btn-clear-search" class="btn btn-small btn-secondary">Clear</button>
        </div>
        <div id="search-grid" class="search-results-grid"></div>
    </div>
</div>

{% block scripts %}
<script>
    (function () {
        const searchInput = document.getElementById('tmdb-search-input');
        const trendingGrid = document.getElementById('trending-grid');
        const searchSection = document.getElementById('search-results-section');
        const searchGrid = document.getElementById('search-grid');
        const heroSection = document.getElementById('discover-hero');
        const btnClear = document.getElementById('btn-clear-search');

        // Initial Load (Trending)
        // Since we don't have a dedicated "Trending" endpoint yet, 
        // we can use the search endpoint with a default query or add a trending endpoint.
        // For MVP, let's use search?q=a or similar to populate something, or better:
        // Update tmdb_routes.py to support /trending if user wants a real discover page.
        // But user requirements just said "Main search page... firstly look for movies/TV".
        // I'll stick to search-first for now, or just show empty state ("Search to discover").
        // Wait, requirements: "Use Discover as the main search page... Parse response"
        // I will implement search first. Trending can be added later if requested.

        trendingGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 4rem;">Search for your favorite movies and shows above.</div>';

        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (!query) {
                showHero();
                return;
            }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performTMDBSearch(query), 500);
        });

        async function performTMDBSearch(query) {
            showSearch();
            searchGrid.innerHTML = '<div class="loading-state"><span class="material-icons spinning">refresh</span><p>Searching TMDB...</p></div>';

            try {
                const res = await fetch(`/api/tmdb/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                searchGrid.innerHTML = '';

                if (!res.ok || data.error) {
                    const errorMsg = data.error || `Error ${res.status}`;
                    searchGrid.innerHTML = `<div class="error-state"><span class="material-icons">error_outline</span><p>${errorMsg}</p></div>`;
                    return;
                }

                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        searchGrid.appendChild(createTMDBCard(item));
                    });
                } else {
                    searchGrid.innerHTML = '<div class="empty-state"><span class="material-icons">search_off</span><p>No results found on TMDB</p></div>';
                }

            } catch (e) {
                console.error(e);
                searchGrid.innerHTML = `<div class="error-state"><span class="material-icons">signal_wifi_off</span><p>Connection Failed</p></div>`;
            }
        }

        function createTMDBCard(item) {
            const card = document.createElement('div');
            card.className = 'result-card';
            // Reuse card style from search.html but optimized for click-through
            const isMovie = item.media_type === 'movie';
            const year = item.release_date ? item.release_date.split('-')[0] : (item.first_air_date ? item.first_air_date.split('-')[0] : '');
            const title = item.title || item.name;

            card.innerHTML = `
                <div class="card-v2-header-bg" style="background-image: url('${item.backdrop_url || ''}'); background-size: cover;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4);"></div>
                </div>
                <div class="card-body card-content" style="position: relative; z-index: 1; cursor: pointer;">
                    <div style="display: flex; gap: 1rem;">
                        ${item.poster_url ? `<img src="${item.poster_url}" style="width: 80px; height: 120px; border-radius: 8px; object-fit: cover;">` : ''}
                        <div style="flex: 1; min-width: 0;">
                             <h3 class="result-title">${title}</h3>
                             <div class="result-subtitle">${year} â€¢ ${isMovie ? 'Movie' : 'TV Series'}</div>
                             <div style="margin-top: 0.5rem; color: gold; font-size: 0.85rem;">
                                 <span class="material-icons" style="font-size: 14px; vertical-align: middle;">star</span> ${item.score}
                             </div>
                        </div>
                    </div>
                </div>
             `;

            card.addEventListener('click', () => {
                // Navigate to detail page
                window.location.href = `/media/${item.media_type}/${item.id}`;
            });

            return card;
        }

        function showHero() {
            heroSection.style.display = 'block';
            searchSection.style.display = 'none';
        }

        function showSearch() {
            heroSection.style.display = 'none';
            searchSection.style.display = 'block';
        }

        btnClear.addEventListener('click', () => {
            searchInput.value = '';
            showHero();
        });

    })();
</script>
{% endblock %}
{% endblock %}