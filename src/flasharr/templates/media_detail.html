{% extends "base.html" %}

{% block title %}Detail - Fshare Nexus{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Hero Section -->
    <div class="hero-backdrop"
        style="position: relative; height: 400px; background-size: cover; background-position: center;">
        <div
            style="position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, #1a1a1a 100%);">
        </div>

        <div class="hero-content"
            style="position: absolute; bottom: 0; left: 0; padding: 2rem; display: flex; align-items: flex-end; gap: 2rem;">
            <img id="detail-poster" src=""
                style="width: 200px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            <div style="margin-bottom: 1rem;">
                <h1 id="detail-title"
                    style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8);">
                </h1>
                <div class="meta-tags" style="display: flex; gap: 1rem; align-items: center; color: #ccc;">
                    <span id="detail-year" class="tag"></span>
                    <span id="detail-score" class="tag" style="color: gold;"><span class="material-icons"
                            style="font-size: 16px;">star</span> <span></span></span>
                    <span id="detail-genres" class="tag"></span>
                </div>
                <p id="detail-overview" style="max-width: 600px; margin-top: 1rem; line-height: 1.6; color: #ddd;"></p>

                <!-- Movie Actions -->
                <div id="movie-actions" style="margin-top: 1.5rem; display: none;">
                    <button id="btn-dl-movie" class="btn btn-primary btn-large">
                        <span class="material-icons">download</span> Download Movie
                    </button>
                    <!-- Status / Progress area -->
                    <div id="movie-search-status" class="search-status-box" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TV Series Section: Seasons & Episodes -->
    <div id="tv-section" style="padding: 2rem; display: none;">
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="section-title">Seasons</h2>
            <select id="season-select" class="form-select"
                style="width: auto; background: #333; color: white; border: none;">
                <!-- Options injected JS -->
            </select>
            <button id="btn-dl-season" class="btn btn-primary" style="margin-left: auto;">
                <span class="material-icons">download</span> Download Season Pack
            </button>
        </div>

        <div id="episode-list" class="episode-grid">
            <!-- Episodes injected JS -->
            <div class="loading-state">
                <span class="material-icons spinning">refresh</span> Loading episodes...
            </div>
        </div>
    </div>
</div>

<!-- Smart Search Result Modal -->
<div id="search-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Search Results</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="queries-used"
                style="font-size: 0.8rem; color: #888; margin-bottom: 1rem; font-family: monospace;"></div>
            <div id="modal-results-list" class="results-list"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const mediaType = "{{ media_type }}"; // 'movie' or 'tv'
    const tmdbId = "{{ tmdb_id }}";

    // We need to fetch details on load
    (async function init() {
        try {
            const endpoint = `/api/tmdb/${mediaType}/${tmdbId}`;
            const res = await fetch(endpoint);
            if (!res.ok) throw new Error('Failed to load details');
            const data = await res.json();

            renderDetails(data);

            if (mediaType === 'tv') {
                document.getElementById('tv-section').style.display = 'block';
                renderSeasons(data.seasons || [], data.id);
            } else {
                document.getElementById('movie-actions').style.display = 'block';
                setupMovieDownload(data);
            }
        } catch (e) {
            console.error(e);
            document.querySelector('.detail-container').innerHTML = '<div class="error-page">Failed to load content.</div>';
        }
    })();

    function renderDetails(data) {
        document.querySelector('.hero-backdrop').style.backgroundImage = `url('https://image.tmdb.org/t/p/original${data.backdrop_path}')`;
        document.getElementById('detail-poster').src = `https://image.tmdb.org/t/p/w500${data.poster_path}`;
        document.getElementById('detail-title').textContent = data.title || data.name;
        document.getElementById('detail-overview').textContent = data.overview;

        const year = (data.release_date || data.first_air_date || '').split('-')[0];
        document.getElementById('detail-year').textContent = year;
        const score = data.vote_average || 0;
        document.getElementById('detail-score').querySelector('span:last-child').textContent = score.toFixed(1);
    }

    function renderSeasons(seasons, tvId) {
        const select = document.getElementById('season-select');
        select.innerHTML = '';

        // Filter out Season 0 (Specials) if desired, or keep them.
        seasons.forEach(s => {
            if (s.season_number > 0) {
                const opt = document.createElement('option');
                opt.value = s.season_number;
                opt.textContent = `Season ${s.season_number}`;
                select.appendChild(opt);
            }
        });

        // Load first season
        if (seasons.length > 0) {
            loadEpisodes(tvId, seasons.find(s => s.season_number > 0).season_number);
        }

        select.addEventListener('change', (e) => {
            loadEpisodes(tvId, e.target.value);
        });
    }

    async function loadEpisodes(tvId, seasonNum) {
        const grid = document.getElementById('episode-list');
        grid.innerHTML = '<div class="loading-state"><span class="material-icons spinning">refresh</span> Loading episodes...</div>';

        try {
            const res = await fetch(`/api/tmdb/tv/${tvId}/season/${seasonNum}`);
            const data = await res.json();

            grid.innerHTML = '';

            if (data.episodes) {
                data.episodes.forEach(ep => {
                    const card = document.createElement('div');
                    card.className = 'episode-card'; // Add Css for this
                    card.innerHTML = `
                        <div class="ep-img" style="position: relative;">
                            <img src="https://image.tmdb.org/t/p/w300${ep.still_path || ''}" onerror="this.src='/static/placeholder.jpg'" style="width: 100%; border-radius: 8px;">
                            <button class="btn-micro-dl" data-s="${seasonNum}" data-e="${ep.episode_number}">
                                <span class="material-icons">download</span>
                            </button>
                        </div>
                        <div class="ep-info" style="margin-top: 5px;">
                            <div style="font-weight: bold;">${ep.episode_number}. ${ep.name}</div>
                            <div style="font-size: 0.8rem; color: #888;">${ep.air_date}</div>
                        </div>
                    `;
                    grid.appendChild(card);

                    // Click handler
                    card.querySelector('.btn-micro-dl').addEventListener('click', (e) => {
                        e.stopPropagation();
                        triggerSmartDownload(document.getElementById('detail-title').textContent, seasonNum, ep.episode_number);
                    });
                });
            }
        } catch (e) {
            grid.innerHTML = 'Error loading episodes';
        }
    }

    function setupMovieDownload(data) {
        document.getElementById('btn-dl-movie').addEventListener('click', () => {
            triggerSmartDownload(data.title, null, null, data.release_date.split('-')[0]);
        });
    }

    async function triggerSmartDownload(title, season, episode, year) {
        // Show Modal with loading
        const modal = document.getElementById('search-modal');
        const list = document.getElementById('modal-results-list');
        const debug = modal.querySelector('.queries-used');

        modal.style.display = 'flex';
        list.innerHTML = '<div class="loading-state"><span class="material-icons spinning">search</span> Searching Fshare...</div>';
        debug.textContent = '';

        try {
            const res = await fetch('/api/discovery/smart-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, season, episode, year })
            });
            const data = await res.json();

            debug.textContent = `Queries: ${data.queries_used.join(', ')}`;
            list.innerHTML = '';

            if (data.results && data.results.length > 0) {
                data.results.forEach(r => {
                    const row = document.createElement('div');
                    row.className = 'result-row'; // Use search.html styles
                    row.style = "background: #2a2a2a; padding: 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;";
                    row.innerHTML = `
                        <div style="overflow: hidden; text-overflow: ellipsis;">
                            <div style="font-weight: 600;">${r.name}</div>
                            <div style="font-size: 0.8rem; color: #aaa;">${((r.size_bytes || 0) / 1024 / 1024 / 1024).toFixed(2)} GB</div>
                        </div>
                        <button class="btn btn-small btn-success" onclick="downloadItem('${r.url}')">
                            <span class="material-icons">download</span>
                        </button>
                     `;
                    list.appendChild(row);
                });
            } else {
                list.innerHTML = '<div class="empty-state">No matching files found.</div>';
            }

        } catch (e) {
            list.innerHTML = `<div class="error-msg">Search failed: ${e.message}</div>`;
        }
    }

    window.downloadItem = async (url) => {
        // Reuse download logic from search.html (might need to move to global script or copy)
        // Simple fetch to /api/download
        try {
            await fetch('/api/downloads', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            alert('Download started!');
            document.getElementById('search-modal').style.display = 'none';
        } catch (e) {
            alert('Failed to start download');
        }
    };

    // Close modal
    document.querySelector('.close-modal').addEventListener('click', () => {
        document.getElementById('search-modal').style.display = 'none';
    });

</script>

<style>
    .episode-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .btn-micro-dl {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s;
    }

    .btn-micro-dl:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}