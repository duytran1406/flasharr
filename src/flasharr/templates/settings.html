{% extends "base.html" %}

{% block title %}Settings - Fshare Nexus{% endblock %}

{% block header_content %}
<div class="settings-tabs-header" style="display: flex; gap: 0.5rem; height: 100%; align-items: center;">
    <button class="tab-btn active" data-tab="account"
        style="height: 36px; padding: 0 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
        <span class="material-icons" style="font-size: 18px;">person</span> Account
    </button>
    <button class="tab-btn" data-tab="downloads"
        style="height: 36px; padding: 0 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
        <span class="material-icons" style="font-size: 18px;">cloud_download</span> Downloads
    </button>
    <button class="tab-btn" data-tab="integration"
        style="height: 36px; padding: 0 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
        <span class="material-icons" style="font-size: 18px;">extension</span> Integration
    </button>
    <button class="tab-btn" data-tab="appearance"
        style="height: 36px; padding: 0 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
        <span class="material-icons" style="font-size: 18px;">palette</span> Appearance
    </button>
</div>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Tab Content -->

    <!-- Tab Content -->
    <div class="settings-content">
        <!-- Account Tab -->
        <div class="tab-panel active" id="tab-account">
            <div class="settings-card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h2>Fshare Accounts</h2>
                            <p class="card-description">Manage multiple Fshare.vn accounts for downloading files.</p>
                        </div>
                        <button class="btn btn-primary" id="btn-add-account">
                            <span class="material-icons">add</span>
                            Add Account
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="accounts-container" class="account-list-container">
                        <!-- Accounts will be loaded here -->
                        <div class="loading-state">
                            <span class="material-icons spinning">sync</span>
                            <p>Loading accounts...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Downloads Tab -->
        <div class="tab-panel" id="tab-downloads">
            <div class="settings-card">
                <div class="card-header">
                    <h2>Download Settings</h2>
                    <p class="card-description">Configure download paths and behavior.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="download_path">Download Path</label>
                        <input type="text" id="download_path" class="form-input" placeholder="/downloads">
                        <span class="form-hint">Base directory for all downloads</span>
                    </div>
                    <div class="form-group">
                        <label>Category Paths</label>
                        <div class="category-paths">
                            <div class="category-row">
                                <span class="category-label">Radarr (Movies)</span>
                                <input type="text" id="path_radarr" class="form-input" placeholder="movies">
                            </div>
                            <div class="category-row">
                                <span class="category-label">Sonarr (TV)</span>
                                <input type="text" id="path_sonarr" class="form-input" placeholder="tv">
                            </div>
                            <!-- Lidarr removed -->
                        </div>
                    </div>
                    <div class="form-row" style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="width: 80%; margin-bottom: 0;">
                            <label for="max_concurrent">Max Concurrent Downloads</label>
                            <div style="display: flex; align-items: center; gap: 1rem; width: 100%;">
                                <input type="range" id="max_concurrent" class="form-range" min="1" max="10" value="3"
                                    style="flex: 1;">
                                <span class="range-value" id="max_concurrent_value" style="min-width: 20px;">3</span>
                            </div>
                        </div>
                        <div class="form-group" style="width: 20%; margin-bottom: 0;">
                            <label for="speed_limit">Speed Limit (MB/s)</label>
                            <input type="number" id="speed_limit" class="form-input" placeholder="0 = Unlimited" min="0"
                                style="width: 100%;">
                        </div>
                    </div>
                    <div class="form-group flex-between" style="padding-right: 1.5rem;">
                        <span class="toggle-text">Auto-resume interrupted downloads</span>
                        <label class="toggle-label-right">
                            <input type="checkbox" id="auto_resume" class="toggle-input" checked>
                            <span class="toggle-switch"></span>
                        </label>
                    </div>

                    <div style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                        <button class="btn btn-primary" id="btn-save-downloads">
                            <span class="material-icons">save</span>
                            Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integration Tab -->
        <div class="tab-panel" id="tab-integration">
            <div class="settings-card">
                <div class="card-header">
                    <h2>*arr Integration</h2>
                    <p class="card-description">API keys for Prowlarr/Radarr/Sonarr integration.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="base_url">Base URL</label>
                        <input type="text" id="base_url" class="form-input" placeholder="http://localhost:8484">
                        <span class="form-hint">Used for reverse proxy setups</span>
                    </div>
                    <div class="form-group">
                        <label for="indexer_api_key">Indexer API Key</label>
                        <div class="input-with-btn">
                            <input type="text" id="indexer_api_key" class="form-input" readonly>
                            <button class="btn btn-small" id="btn-gen-indexer-key">Generate</button>
                            <button class="btn-copy" data-target="indexer_api_key">
                                <span class="material-icons">content_copy</span>
                            </button>
                        </div>
                        <span class="form-hint">Use this key in Prowlarr indexer settings</span>
                    </div>
                    <div class="form-group">
                        <label for="sabnzbd_api_key">SABnzbd API Key</label>
                        <div class="input-with-btn">
                            <input type="text" id="sabnzbd_api_key" class="form-input" readonly>
                            <button class="btn btn-small" id="btn-gen-sab-key">Generate</button>
                            <button class="btn-copy" data-target="sabnzbd_api_key">
                                <span class="material-icons">content_copy</span>
                            </button>
                        </div>
                        <span class="form-hint">Use this key in Radarr/Sonarr download client settings</span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="enable_indexer" class="toggle-input" checked>
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">Enable Indexer API</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="enable_sabnzbd" class="toggle-input" checked>
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">Enable SABnzbd API</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sonarr Integration -->
            <div class="settings-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="material-icons" style="color: #4da6ff;">tv</span>
                        <h2>Sonarr Integration</h2>
                    </div>
                    <p class="card-description">Configure connection to Sonarr for TV Shows.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="sonarr_url">Sonarr URL</label>
                        <input type="text" id="sonarr_url" class="form-input" placeholder="http://localhost:8989">
                    </div>
                    <div class="form-group">
                        <label for="sonarr_api_key">API Key</label>
                        <input type="password" id="sonarr_api_key" class="form-input" placeholder="Sonarr API Key">
                    </div>
                    <div class="form-group" style="margin-top: 1rem; text-align: right;">
                        <button class="btn btn-secondary" id="btn-test-sonarr">
                            <span class="material-icons">link</span> Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Radarr Integration -->
            <div class="settings-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="material-icons" style="color: #ffcc00;">movie</span>
                        <h2>Radarr Integration</h2>
                    </div>
                    <p class="card-description">Configure connection to Radarr for Movies.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="radarr_url">Radarr URL</label>
                        <input type="text" id="radarr_url" class="form-input" placeholder="http://localhost:7878">
                    </div>
                    <div class="form-group">
                        <label for="radarr_api_key">API Key</label>
                        <input type="password" id="radarr_api_key" class="form-input" placeholder="Radarr API Key">
                    </div>
                    <div class="form-group" style="margin-top: 1rem; text-align: right;">
                        <button class="btn btn-secondary" id="btn-test-radarr">
                            <span class="material-icons">link</span> Test Connection
                        </button>
                    </div>
                </div>
            </div>

            <!-- TMDB Integration -->
            <div class="settings-card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="material-icons" style="color: #01b4e4;">movie_filter</span>
                        <h2>TMDB Integration</h2>
                    </div>
                    <p class="card-description">Configure The Movie Database API for discovery.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="tmdb_api_key">TMDB API Key</label>
                        <input type="password" id="tmdb_api_key" class="form-input" placeholder="TMDB API Key (v3)">
                        <p class="form-help">Required for "TheMovieDB" search mode.</p>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" id="btn-save-integration">
                    <span class="material-icons">save</span>
                    Save Integration Settings
                </button>
            </div>
        </div>

        <!-- Appearance Tab -->
        <div class="tab-panel" id="tab-appearance">
            <div class="settings-card">
                <div class="card-header">
                    <h2>Appearance</h2>
                    <p class="card-description">Customize the look and feel.</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Theme</label>
                        <div class="theme-selector">
                            <label class="theme-option">
                                <input type="radio" name="theme" value="dark">
                                <div class="theme-preview dark-preview">
                                    <span class="material-icons">dark_mode</span>
                                </div>
                                <span>Oceanholic (Dark)</span>
                            </label>
                            <label class="theme-option">
                                <input type="radio" name="theme" value="light">
                                <div class="theme-preview light-preview">
                                    <span class="material-icons">light_mode</span>
                                </div>
                                <span>Arctic (Light)</span>
                            </label>
                            <label class="theme-option">
                                <input type="radio" name="theme" value="system">
                                <div class="theme-preview system-preview">
                                    <span class="material-icons">settings_brightness</span>
                                </div>
                                <span>System</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="language">Language</label>
                        <select id="language" class="form-select">
                            <option value="en">English</option>
                            <option value="vi">Tiếng Việt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="refresh_interval">Dashboard Refresh Interval</label>
                        <select id="refresh_interval" class="form-select">
                            <option value="1000">1 second</option>
                            <option value="3000" selected>3 seconds</option>
                            <option value="5000">5 seconds</option>
                            <option value="10000">10 seconds</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Debug Section -->
            <div class="settings-card" style="margin-top: 1.5rem; border-color: rgba(255, 255, 255, 0.1);">
                <div class="card-header">
                    <h2>Debug & Testing</h2>
                    <p class="card-description">Development tools for UI verification.</p>
                </div>
                <div class="card-body">
                    <div class="form-group flex-between">
                        <span class="toggle-text">Inject Mock Download Data</span>
                        <button class="btn btn-secondary" onclick="window.fshareBridgeInstance.addDebugItems()">
                            <span class="material-icons">bug_report</span>
                            Add Mock Items
                        </button>
                    </div>
                    <p class="form-hint" style="margin-top: 0.5rem;">
                        Adds fake download entries to the list to test layout without using real quota.
                        Refreshes automatically.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <span class="toast-icon material-icons">check_circle</span>
    <span class="toast-message"></span>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center;">
    <div class="service-card"
        style="width: 100%; max-width: 500px; padding: 2rem; border-color: rgba(59, 130, 246, 0.3);">
        <div class="service-header" style="margin-bottom: 2rem;">
            <div class="service-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <span class="material-icons">login</span>
            </div>
            <div class="service-title" style="font-size: 1.25rem; font-weight: 700;">Login to Fshare</div>
            <button id="modal-close"
                style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label
                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 700;">Email</label>
            <input type="email" id="modal_email" class="elegant-search-input" style="padding-left: 1rem;"
                placeholder="your@email.com">
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label
                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 700;">Password</label>
            <div style="position: relative;">
                <input type="password" id="modal_password" class="elegant-search-input" style="padding-left: 1rem;"
                    placeholder="••••••••">
                <button class="toggle-password" data-target="modal_password"
                    style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;">
                    <span class="material-icons" style="font-size: 1.1rem;">visibility</span>
                </button>
            </div>
        </div>

        <div id="modal-status" class="connection-status"
            style="display: none; margin-bottom: 1.5rem; padding: 0.75rem; border-radius: 8px; font-size: 0.85rem; align-items: center; gap: 0.5rem;">
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button id="btn-modal-cancel" class="icon-action-btn"
                style="width: auto; padding: 0 1.5rem; font-weight: 600; font-size: 0.85rem;">CANCEL</button>
            <button id="btn-modal-login" class="icon-action-btn"
                style="width: auto; padding: 0 1.5rem; background: #3b82f6; color: white; border: none; font-weight: 600; font-size: 0.85rem;">
                <span class="material-icons" style="font-size: 18px; margin-right: 0.5rem;">login</span>
                LOGIN
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        // Tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                tabBtns.forEach(b => b.classList.remove('active'));
                tabPanels.forEach(p => p.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.add('active');

                // Refresh accounts when switching to account tab
                if (tab === 'account') {
                    loadAccounts();
                }
            });
        });

        // Password visibility toggle
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = document.getElementById(btn.dataset.target);
                const icon = btn.querySelector('.material-icons');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.textContent = 'visibility_off';
                } else {
                    input.type = 'password';
                    icon.textContent = 'visibility';
                }
            });
        });

        // Range slider value display
        const rangeSlider = document.getElementById('max_concurrent');
        const rangeValue = document.getElementById('max_concurrent_value');
        rangeSlider.addEventListener('input', () => {
            rangeValue.textContent = rangeSlider.value;
        });

        // Copy to clipboard
        document.querySelectorAll('.btn-copy').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = document.getElementById(btn.dataset.target);
                navigator.clipboard.writeText(input.value);
                showToast('Copied to clipboard');
            });
        });

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            const icon = toast.querySelector('.toast-icon');
            const msg = toast.querySelector('.toast-message');

            msg.textContent = message;
            icon.textContent = type === 'success' ? 'check_circle' : 'error';
            toast.className = `toast show ${type}`;

            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- ACCOUNT MANAGEMENT ---
        const loginModal = document.getElementById('login-modal');
        const accountsContainer = document.getElementById('accounts-container');

        async function loadAccounts() {
            console.log('Fetching accounts...');
            try {
                const response = await fetch('/api/accounts');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                console.log('Accounts loaded:', data);

                if (data.status === 'ok') {
                    renderAccounts(data.accounts, data.primary);
                } else {
                    throw new Error(data.message || 'Unknown server error');
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                accountsContainer.innerHTML = `
                    <div class="empty-accounts" style="border-color: rgba(239, 68, 68, 0.2);">
                        <span class="material-icons" style="color: #ef4444;">error</span>
                        <p>Failed to load accounts: ${error.message}</p>
                        <button class="btn btn-secondary" onclick="location.reload()">
                            <span class="material-icons">refresh</span>
                            Retry
                        </button>
                    </div>
                `;
            }
        }
        window.loadAccounts = loadAccounts;

        function renderAccounts(accounts, primary) {
            console.log('Rendering accounts...', accounts);
            if (!accounts || accounts.length === 0) {
                accountsContainer.innerHTML = `
                    <div class="empty-accounts">
                        <span class="material-icons">account_circle</span>
                        <p>No Fshare accounts configured. Add an account to start downloading.</p>
                        <button class="btn btn-primary" onclick="window.showLoginModal()">
                            <span class="material-icons">login</span>
                            Login Now
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="account-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Account</th>
                            <th style="width: 15%;">Status</th>
                            <th style="width: 25%;">Daily Traffic</th>
                            <th style="width: 20%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            accounts.forEach(acc => {
                const isPrimary = primary && (acc.email === primary.email);
                const premiumClass = acc.premium ? 'premium' : 'expired';
                const premiumText = acc.premium ? (acc.account_type || 'VIP') : 'Free';

                // Format traffic and progress bar
                let trafficHtml = '<span class="status-badge">N/A</span>';
                if (acc.traffic_left) {
                    // Try to parse "Used / Total" format
                    const parts = acc.traffic_left.split('/');
                    if (parts.length === 2) {
                        const used = parseFloat(parts[0]);
                        const total = parseFloat(parts[1]);
                        const percent = Math.min(100, Math.max(0, (used / total) * 100));

                        trafficHtml = `
                            <div class="traffic-info">
                                <div class="traffic-meta">
                                    <span>${acc.traffic_left}</span>
                                    <span>${Math.round(percent)}%</span>
                                </div>
                                <div class="traffic-progress-container">
                                    <div class="traffic-progress-fill" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    } else {
                        trafficHtml = `
                            <div class="traffic-info">
                                <span class="traffic-value">${acc.traffic_left}</span>
                            </div>
                        `;
                    }
                }

                let validUntil = 'N/A';
                if (acc.validuntil) {
                    if (acc.validuntil === -1) {
                        validUntil = 'Lifetime';
                    } else if (typeof acc.validuntil === 'number') {
                        validUntil = new Date(acc.validuntil * 1000).toLocaleDateString('en-GB');
                    } else {
                        validUntil = acc.validuntil;
                    }
                }

                html += `
                    <tr class="${isPrimary ? 'primary-row' : ''}">
                        <td data-label="ACCOUNT">
                            <div class="account-cell">
                                <div class="account-email-info">
                                    <span class="email-text">${acc.email}</span>
                                    ${isPrimary ? '<span class="badge-primary">PRIMARY</span>' : ''}
                                </div>
                                <div class="account-meta">
                                    <span class="meta-item"><span class="material-icons">event</span> ${validUntil}</span>
                                </div>
                            </div>
                        </td>
                        <td data-label="STATUS">
                            <span class="status-badge ${acc.premium ? 'success' : ''}">${premiumText}</span>
                        </td>
                        <td data-label="DAILY TRAFFIC">
                            ${trafficHtml}
                        </td>
                        <td data-label="ACTIONS">
                            <div class="account-actions">
                                <button onclick="refreshAccount('${acc.email}')" title="Refresh Account" class="action-btn-refresh">
                                    <span class="material-icons">refresh</span>
                                </button>
                                ${!isPrimary ? `
                                    <button onclick="setPrimaryAccount('${acc.email}')" title="Set as Primary" class="action-btn-star">
                                        <span class="material-icons">star_border</span>
                                    </button>
                                ` : ''}
                                <button onclick="removeAccount('${acc.email}')" title="Remove Account" class="action-btn-delete">
                                    <span class="material-icons">delete_outline</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            accountsContainer.innerHTML = html;
        }
        window.renderAccounts = renderAccounts;

        window.showLoginModal = () => {
            loginModal.style.display = 'flex';
            document.getElementById('modal-status').style.display = 'none';
        };

        const hideLoginModal = () => {
            loginModal.style.display = 'none';
            document.getElementById('modal_email').value = '';
            document.getElementById('modal_password').value = '';
        };

        document.getElementById('btn-add-account').addEventListener('click', window.showLoginModal);
        document.getElementById('btn-modal-cancel').addEventListener('click', hideLoginModal);
        document.getElementById('modal-close').addEventListener('click', hideLoginModal);

        document.getElementById('btn-modal-login').addEventListener('click', async () => {
            const email = document.getElementById('modal_email').value;
            const password = document.getElementById('modal_password').value;
            const status = document.getElementById('modal-status');
            const btn = document.getElementById('btn-modal-login');

            if (!email || !password) {
                status.textContent = 'Email and password required';
                status.className = 'connection-status error';
                status.style.display = 'flex';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons spin">sync</span> Logging in...';
            status.innerHTML = '<span class="material-icons spin">sync</span> authenticating...';
            status.className = 'connection-status testing';
            status.style.display = 'flex';

            try {
                const response = await fetch('/api/accounts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    showToast('Account added successfully');
                    hideLoginModal();
                    loadAccounts();
                } else {
                    status.textContent = data.message || 'Login failed';
                    status.className = 'connection-status error';
                }
            } catch (error) {
                status.textContent = 'Connection error';
                status.className = 'connection-status error';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons">login</span> Login';
            }
        });

        window.refreshAccount = async (email) => {
            try {
                const response = await fetch(`/api/accounts/${email}/refresh`, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'ok') {
                    showToast(`Account ${email} refreshed`);
                    loadAccounts();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Refresh failed', 'error');
            }
        };

        window.setPrimaryAccount = async (email) => {
            try {
                const response = await fetch(`/api/accounts/${email}/set-primary`, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'ok') {
                    showToast(`Primary account set to ${email}`);
                    loadAccounts();
                }
            } catch (error) {
                showToast('Action failed', 'error');
            }
        };

        window.removeAccount = async (email) => {
            if (!confirm(`Are you sure you want to remove ${email}?`)) return;
            try {
                const response = await fetch(`/api/accounts/${email}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.status === 'ok') {
                    showToast('Account removed');
                    loadAccounts();
                }
            } catch (error) {
                showToast('Removal failed', 'error');
            }
        };

        // --- HEALTH CHECK ---
        async function checkAccountHealth() {
            try {
                const response = await fetch('/api/verify-account', { method: 'POST' });

                if (response.status === 401) {
                    const data = await response.json();
                    if (data.code === 'SESSION_EXPIRED' || data.code === 'NO_ACCOUNT') {
                        showSessionExpiredModal(data.message);
                    }
                }
            } catch (error) {
                console.error("Health check failed:", error);
            }
        }

        function showSessionExpiredModal(message) {
            // Reuse login modal but with error state
            const status = document.getElementById('modal-status');
            const title = document.querySelector('.service-title');

            loginModal.style.display = 'flex';
            title.textContent = "Session Expired";
            status.textContent = message || "Your session has expired. Please login again.";
            status.className = 'connection-status error';
            status.style.display = 'flex';
        }

        // Hook into finish of loadAccounts or call independently
        // We'll call it after initial load
        setTimeout(checkAccountHealth, 1000);


        // Load settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();

                if (data.status === 'ok') {
                    const s = data.settings;

                    // Skip account email/password loading as it's now multi-account

                    // Downloads
                    document.getElementById('download_path').value = s.download_path || '/downloads';
                    document.getElementById('max_concurrent').value = s.max_concurrent_downloads || 3;
                    rangeValue.textContent = s.max_concurrent_downloads || 3;
                    document.getElementById('speed_limit').value = s.speed_limit_mbps || 0;
                    document.getElementById('auto_resume').checked = s.auto_resume !== false;

                    // Category paths
                    if (s.category_paths) {
                        document.getElementById('path_radarr').value = s.category_paths.radarr || 'movies';
                        document.getElementById('path_sonarr').value = s.category_paths.sonarr || 'tv';
                        // path_lidarr removed
                    }

                    // Integration
                    document.getElementById('base_url').value = s.base_url || 'http://localhost:8484';
                    document.getElementById('indexer_api_key').value = s.indexer_api_key || '';
                    document.getElementById('sabnzbd_api_key').value = s.sabnzbd_api_key || '';
                    document.getElementById('enable_indexer').checked = s.enable_indexer !== false;
                    document.getElementById('enable_sabnzbd').checked = s.enable_sabnzbd !== false;

                    // Sonarr / Radarr
                    if (s.sonarr) {
                        document.getElementById('sonarr_url').value = s.sonarr.url || '';
                        document.getElementById('sonarr_api_key').value = s.sonarr.api_key || '';
                    }
                    if (s.radarr) {
                        document.getElementById('radarr_url').value = s.radarr.url || '';
                        document.getElementById('radarr_api_key').value = s.radarr.api_key || '';
                    }
                    if (s.tmdb_api_key) {
                        document.getElementById('tmdb_api_key').value = s.tmdb_api_key;
                    }

                    // Appearance
                    const theme = s.theme || localStorage.getItem('flasharr_theme') || 'dark';
                    const themeInput = document.querySelector(`input[name="theme"][value="${theme}"]`);
                    if (themeInput) themeInput.checked = true;
                    document.getElementById('language').value = s.language || 'en';
                    document.getElementById('refresh_interval').value = s.refresh_interval || 3000;

                    // Sync app theme if bridge exists
                    const bridge = window.fshareBridgeInstance;
                    if (bridge) {
                        bridge.applyTheme(theme);
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings (Global helper)
        async function saveSettings(settings, btn = null) {
            try {
                if (btn) {
                    btn.disabled = true;
                    btn._oldHTML = btn.innerHTML;
                    btn.innerHTML = '<span class="material-icons spin">sync</span> Saving...';
                }

                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings),
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    showToast('Settings saved successfully');
                } else {
                    showToast(data.message || 'Failed to save', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('Error saving settings', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = btn._oldHTML;
                }
            }
        }

        // Save Download settings (specific button)
        const btnSaveDownloads = document.getElementById('btn-save-downloads');
        if (btnSaveDownloads) {
            btnSaveDownloads.addEventListener('click', () => {
                const settings = {
                    download_path: document.getElementById('download_path').value,
                    category_paths: {
                        radarr: document.getElementById('path_radarr').value,
                        sonarr: document.getElementById('path_sonarr').value,
                    },
                    max_concurrent_downloads: parseInt(document.getElementById('max_concurrent').value),
                    speed_limit_mbps: parseInt(document.getElementById('speed_limit').value) || 0,
                    auto_resume: document.getElementById('auto_resume').checked,
                };
                saveSettings(settings, btnSaveDownloads);
            });
        }

        // Global Save button removed from header, functionality moved to specific tabs if needed
        const btnSave = document.getElementById('btn-save');
        if (btnSave) {
            btnSave.addEventListener('click', async () => {
                const settings = {
                    category_paths: {
                        radarr: document.getElementById('path_radarr').value,
                        sonarr: document.getElementById('path_sonarr').value,
                    },
                    base_url: document.getElementById('base_url').value,
                    enable_indexer: document.getElementById('enable_indexer').checked,
                    enable_sabnzbd: document.getElementById('enable_sabnzbd').checked,
                    theme: document.querySelector('input[name="theme"]:checked').value,
                    language: document.getElementById('language').value,
                    refresh_interval: parseInt(document.getElementById('refresh_interval').value),
                };
                saveSettings(settings, btnSave);
            });
        }

        // Removed btn-test-connection as it's now handled in the modal login

        // Generate API keys
        document.getElementById('btn-gen-indexer-key').addEventListener('click', async () => {
            const response = await fetch('/api/settings/generate-api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'indexer' }),
            });
            const data = await response.json();
            if (data.status === 'ok') {
                document.getElementById('indexer_api_key').value = data.key;
                showToast('New indexer key generated');
            }
        });

        document.getElementById('btn-gen-sab-key').addEventListener('click', async () => {
            const response = await fetch('/api/settings/generate-api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'sabnzbd' }),
            });
            const data = await response.json();
            if (data.status === 'ok') {
                document.getElementById('sabnzbd_api_key').value = data.key;
                showToast('New SABnzbd key generated');
            }
        });

        // Save Integration settings
        const btnSaveIntegration = document.getElementById('btn-save-integration');
        if (btnSaveIntegration) {
            btnSaveIntegration.addEventListener('click', () => {
                const settings = {
                    base_url: document.getElementById('base_url').value,
                    enable_indexer: document.getElementById('enable_indexer').checked,
                    enable_sabnzbd: document.getElementById('enable_sabnzbd').checked,
                    sonarr: {
                        url: document.getElementById('sonarr_url').value,
                        api_key: document.getElementById('sonarr_api_key').value
                    },
                    radarr: {
                        url: document.getElementById('radarr_url').value,
                        api_key: document.getElementById('radarr_api_key').value
                    },
                    tmdb_api_key: document.getElementById('tmdb_api_key').value
                };
                saveSettings(settings, btnSaveIntegration);
            });
        }

        // Test Sonarr
        document.getElementById('btn-test-sonarr').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons spin">sync</span> Testing...';

            try {
                // Save first to ensure backend has latest creds? Or send valid endpoint test
                // Since we don't have a direct test endpoint that accepts creds yet, 
                // we rely on saved settings OR we should update verify endpoint.
                // For now, let's assume user saves first or we trigger a special test call.

                // Simpler: Just try to fetch system status via our proxy IF settings are saved.
                // Ideally we'd send the form values to a test endpoint.
                // Let's implement a quick save-then-test or just basic feedback.

                // Actually relying on the backend settings api update.
                // Since we didn't add a dedicated "test with these credentials" endpoint yet, 
                // checking /api/integration/status is best, but requires saving.

                const response = await fetch('/api/integration/status');
                const status = await response.json();

                if (status.sonarr) {
                    showToast('Sonarr connection successful!');
                } else {
                    showToast('Sonarr connection failed. Check settings.', 'error');
                }

            } catch (e) {
                showToast('Test failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons">link</span> Test Connection';
            }
        });

        // Test Radarr
        document.getElementById('btn-test-radarr').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons spin">sync</span> Testing...';
            try {
                const response = await fetch('/api/integration/status');
                const status = await response.json();

                if (status.radarr) {
                    showToast('Radarr connection successful!');
                } else {
                    showToast('Radarr connection failed. Check settings.', 'error');
                }
            } catch (e) {
                showToast('Test failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons">link</span> Test Connection';
            }
        });

        document.getElementById('btn-gen-sab-key').addEventListener('click', async () => {
            const response = await fetch('/api/settings/generate-api-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'sabnzbd' }),
            });
            const data = await response.json();
            if (data.status === 'ok') {
                document.getElementById('sabnzbd_api_key').value = data.key;
                showToast('New SABnzbd key generated');
            }
        });

        // Theme Click-to-Save logic
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('click', (e) => {
                const theme = e.target.value;
                const bridge = window.fshareBridgeInstance;
                if (bridge) {
                    bridge.applyTheme(theme);
                }
                saveSettings({ theme });
            });
        });

        // Export and Reset buttons removed from UI, listeners removed to prevent JS errors

        // Initial load
        loadSettings();
        loadAccounts();
    })();
</script>
{% endblock %}