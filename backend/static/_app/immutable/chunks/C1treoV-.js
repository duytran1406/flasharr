import{c as k,t as l}from"./CL9ZHmPK.js";import{h as D,a6 as i,a7 as f}from"./rK_yDtst.js";function N(r,o,a,n){var c=r.__style;if(D||c!==o){var d=k(o);(!D||d!==r.getAttribute("style"))&&(d==null?r.removeAttribute("style"):r.style.cssText=d),r.__style=o}return n}class M{ws=null;config;handlers=new Map;reconnectTimer=null;reconnectAttempts=0;intentionalDisconnect=!1;status;lastMessage;error;constructor(o={}){this.config={url:o.url||"ws://localhost:8080/api/ws",reconnectDelay:o.reconnectDelay||5e3,maxReconnectAttempts:o.maxReconnectAttempts||10,debug:o.debug??!0},this.status=f("disconnected"),this.lastMessage=f(null),this.error=f(null)}connect(){if(this.ws?.readyState===WebSocket.OPEN){this.log("Already connected");return}this.intentionalDisconnect=!1,this.status.set("connecting"),this.error.set(null);try{this.log(`Connecting to ${this.config.url}...`),this.ws=new WebSocket(this.config.url),this.ws.onopen=this.handleOpen.bind(this),this.ws.onmessage=this.handleMessage.bind(this),this.ws.onerror=this.handleError.bind(this),this.ws.onclose=this.handleClose.bind(this)}catch(o){this.log("Connection error:",o),this.status.set("error"),this.error.set(o instanceof Error?o.message:"Connection failed"),this.scheduleReconnect()}}disconnect(){this.log("Disconnecting..."),this.intentionalDisconnect=!0,this.clearReconnectTimer(),this.ws&&(this.ws.close(),this.ws=null),this.status.set("disconnected")}on(o,a){this.handlers.has(o)||this.handlers.set(o,[]),this.handlers.get(o).push(a),this.log(`Registered handler for ${o}`)}off(o,a){const n=this.handlers.get(o);if(n){const c=n.indexOf(a);c>-1&&(n.splice(c,1),this.log(`Unregistered handler for ${o}`))}}send(o){this.ws?.readyState===WebSocket.OPEN?(this.ws.send(JSON.stringify(o)),this.log("Sent message:",o)):this.log("Cannot send message: not connected")}handleOpen(){this.log("âœ… Connected to WebSocket"),this.status.set("connected"),this.error.set(null),this.reconnectAttempts=0}handleMessage(o){try{const a=JSON.parse(o.data);this.log("ğŸ“¨ Received:",a.type,a),this.lastMessage.set(a);const n=this.handlers.get(a.type);n&&n.length>0?n.forEach(c=>{try{c(a)}catch(d){this.log(`Error in handler for ${a.type}:`,d)}}):this.log(`No handlers registered for ${a.type}`)}catch(a){this.log("Failed to parse message:",a),this.error.set("Invalid message received")}}handleError(o){this.log("âŒ WebSocket error:",o),this.status.set("error"),this.error.set("WebSocket connection error")}handleClose(o){this.log(`ğŸ”Œ Disconnected (code: ${o.code}, reason: ${o.reason})`),this.status.set("disconnected"),this.ws=null,this.intentionalDisconnect||this.scheduleReconnect()}scheduleReconnect(){if(this.reconnectAttempts>=this.config.maxReconnectAttempts){this.log(`Max reconnect attempts (${this.config.maxReconnectAttempts}) reached`),this.error.set("Failed to reconnect after multiple attempts");return}this.clearReconnectTimer();const o=this.config.reconnectDelay*Math.pow(1.5,this.reconnectAttempts);this.reconnectAttempts++,this.log(`Reconnecting in ${o}ms (attempt ${this.reconnectAttempts})...`),this.reconnectTimer=window.setTimeout(()=>{this.connect()},o)}clearReconnectTimer(){this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}log(...o){this.config.debug&&console.log("[WebSocket]",...o)}get isConnected(){return this.ws?.readyState===WebSocket.OPEN}}const h=new M;i(h.status,r=>r==="connected");const F=i(h.status,r=>{switch(r){case"connected":return{text:"Connected",color:"green",icon:"ğŸŸ¢"};case"connecting":return{text:"Connecting...",color:"yellow",icon:"ğŸŸ¡"};case"disconnected":return{text:"Disconnected",color:"gray",icon:"âšª"};case"error":return{text:"Error",color:"red",icon:"ğŸ”´"};default:return{text:"Unknown",color:"gray",icon:"âšª"}}});function P(){const r={downloads:new Map,stats:{active_downloads:0,queued:0,completed:0,failed:0,total_speed:0,rate_limiter_enabled:!1},loading:!1,error:null},{subscribe:o,set:a,update:n}=f(r),c="http://localhost:8080/api";async function d(){n(t=>({...t,loading:!0,error:null}));try{const t=await fetch(`${c}/downloads`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.json(),s=new Map;e.downloads.forEach(u=>{s.set(u.id,u)}),n(u=>({...u,downloads:s,stats:e.stats,loading:!1})),console.log("[DownloadStore] Fetched",s.size,"downloads")}catch(t){const e=t instanceof Error?t.message:"Failed to fetch downloads";console.error("[DownloadStore] Fetch error:",e),n(s=>({...s,loading:!1,error:e}))}}async function p(t){try{const e=await fetch(`${c}/downloads`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await e.json();if(!e.ok)throw new Error(s.error||s.message||`HTTP ${e.status}`);return console.log("[DownloadStore] Added download:",s.task_id),l.success(`Download added: ${s.filename}`),{success:!0,data:s}}catch(e){const s=e instanceof Error?e.message:"Failed to add download";return console.error("[DownloadStore] Add error:",s),l.error(`Failed to add download: ${s}`),{success:!1,error:s}}}async function S(t){try{const e=await fetch(`${c}/downloads/${t}/pause`,{method:"POST"});if(!e.ok){const s=await e.json();throw new Error(s.error||`HTTP ${e.status}`)}return console.log("[DownloadStore] Paused download:",t),l.info("Download paused"),{success:!0}}catch(e){const s=e instanceof Error?e.message:"Failed to pause download";return console.error("[DownloadStore] Pause error:",s),l.error(`Failed to pause: ${s}`),{success:!1,error:s}}}async function m(t){try{const e=await fetch(`${c}/downloads/${t}/resume`,{method:"POST"});if(!e.ok){const s=await e.json();throw new Error(s.error||`HTTP ${e.status}`)}return console.log("[DownloadStore] Resumed download:",t),l.success("Download resumed"),{success:!0}}catch(e){const s=e instanceof Error?e.message:"Failed to resume download";return console.error("[DownloadStore] Resume error:",s),l.error(`Failed to resume: ${s}`),{success:!1,error:s}}}async function E(t){try{const e=await fetch(`${c}/downloads/${t}`,{method:"DELETE"});if(!e.ok){const s=await e.json();throw new Error(s.error||`HTTP ${e.status}`)}return console.log("[DownloadStore] Deleted download:",t),l.info("Download deleted"),{success:!0}}catch(e){const s=e instanceof Error?e.message:"Failed to delete download";return console.error("[DownloadStore] Delete error:",s),l.error(`Failed to delete: ${s}`),{success:!1,error:s}}}async function T(t){try{const e=await fetch(`${c}/downloads/${t}/retry`,{method:"POST"});if(!e.ok){const s=await e.json();throw new Error(s.error||`HTTP ${e.status}`)}return console.log("[DownloadStore] Retrying download:",t),l.success("Download retry initiated"),{success:!0}}catch(e){const s=e instanceof Error?e.message:"Failed to retry download";return console.error("[DownloadStore] Retry error:",s),l.error(`Failed to retry: ${s}`),{success:!1,error:s}}}async function y(){try{const t=await fetch(`${c}/downloads/pause-all`,{method:"POST"}),e=await t.json();if(!t.ok)throw new Error(e.error||`HTTP ${t.status}`);return console.log("[DownloadStore] Paused all downloads:",e.affected),l.info(`Paused ${e.affected} download${e.affected!==1?"s":""}`),{success:!0,data:e}}catch(t){const e=t instanceof Error?t.message:"Failed to pause all downloads";return console.error("[DownloadStore] Pause all error:",e),l.error(`Failed to pause all: ${e}`),{success:!1,error:e}}}async function A(){try{const t=await fetch(`${c}/downloads/resume-all`,{method:"POST"}),e=await t.json();if(!t.ok)throw new Error(e.error||`HTTP ${t.status}`);return console.log("[DownloadStore] Resumed all downloads:",e.affected),l.success(`Resumed ${e.affected} download${e.affected!==1?"s":""}`),{success:!0,data:e}}catch(t){const e=t instanceof Error?t.message:"Failed to resume all downloads";return console.error("[DownloadStore] Resume all error:",e),l.error(`Failed to resume all: ${e}`),{success:!1,error:e}}}function $(){h.on("SYNC_ALL",t=>{if(console.log("[DownloadStore] SYNC_ALL received:",t.tasks?.length||0,"tasks"),t.tasks&&Array.isArray(t.tasks)){const e=new Map;t.tasks.forEach(s=>{e.set(s.id,s)}),n(s=>({...s,downloads:e}))}}),h.on("TASK_ADDED",t=>{console.log("[DownloadStore] TASK_ADDED:",t.task?.id),t.task&&n(e=>{const s=new Map(e.downloads);return s.set(t.task.id,t.task),{...e,downloads:s}})}),h.on("TASK_UPDATED",t=>{t.task&&t.task.id&&n(e=>{const s=new Map(e.downloads),u=s.get(t.task.id);return u?s.set(t.task.id,{...u,...t.task}):s.set(t.task.id,t.task),{...e,downloads:s}})}),h.on("TASK_REMOVED",t=>{console.log("[DownloadStore] TASK_REMOVED:",t.task_id),t.task_id&&n(e=>{const s=new Map(e.downloads);return s.delete(t.task_id),{...e,downloads:s}})}),h.on("ENGINE_STATS",t=>{t.stats&&n(e=>({...e,stats:t.stats}))}),console.log("[DownloadStore] WebSocket handlers initialized")}return{subscribe:o,fetchAll:d,addDownload:p,pauseDownload:S,resumeDownload:m,deleteDownload:E,retryDownload:T,pauseAll:y,resumeAll:A,initWebSocket:$}}const g=P(),w=i(g,r=>Array.from(r.downloads.values()).sort((o,a)=>new Date(a.created_at).getTime()-new Date(o.created_at).getTime())),C=i(w,r=>r.filter(o=>o.state==="DOWNLOADING"||o.state==="STARTING")),_=i(w,r=>r.filter(o=>o.state==="QUEUED")),I=i(w,r=>r.filter(o=>o.state==="COMPLETED")),L=i(w,r=>r.filter(o=>o.state==="FAILED")),W=i(w,r=>r.filter(o=>o.state==="PAUSED")),x=i(g,r=>r.stats),U=i(g,r=>r.loading);i(g,r=>r.error);function O(r){if(r===0)return"0 B";const o=1024,a=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(r)/Math.log(o));return`${(r/Math.pow(o,n)).toFixed(2)} ${a[n]}`}function G(r){return`${O(r)}/s`}function j(r){if(!r||r<=0)return"--";const o=Math.floor(r/3600),a=Math.floor(r%3600/60),n=Math.floor(r%60);return o>0?`${o}h ${a}m`:a>0?`${a}m ${n}s`:`${n}s`}function v(r){switch(r){case"DOWNLOADING":case"STARTING":return"blue";case"COMPLETED":return"green";case"FAILED":return"red";case"PAUSED":return"orange";case"QUEUED":case"WAITING":return"gray";default:return"gray"}}function B(r){switch(r){case"DOWNLOADING":return"â¬‡ï¸";case"STARTING":return"ğŸ”„";case"COMPLETED":return"âœ…";case"FAILED":return"âŒ";case"PAUSED":return"â¸ï¸";case"QUEUED":return"â³";case"WAITING":return"â±ï¸";case"CANCELLED":return"ğŸš«";case"EXTRACTING":return"ğŸ“¦";default:return"â“"}}export{w as a,C as b,I as c,g as d,v as e,L as f,B as g,O as h,U as i,G as j,j as k,x as l,F as m,W as p,_ as q,N as s,h as w};
