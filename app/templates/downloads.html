{% extends "base.html" %}

{% block title %}Downloads - Fshare Nexus{% endblock %}

{% block custom_header %}
<div class="elegant-toolbar"
    style="width: 100%; margin: 0; border: none; background: transparent; backdrop-filter: none; box-shadow: none;">
    <div class="search-wrapper">
        <span class="material-icons">search</span>
        <input type="text" class="elegant-search-input" placeholder="Search by name..." id="downloads-search-input"
            oninput="bridge.loadDownloads()" autocomplete="off">
    </div>

    <div class="action-group">
        <button class="icon-action-btn btn-add" onclick="bridge.showAddModal()" title="Add Link">
            <span class="material-icons">queue</span>
        </button>
        <button class="icon-action-btn btn-start" onclick="bridge.startAllDownloads()" title="Start All">
            <span class="material-icons">play_arrow</span>
        </button>
        <button class="icon-action-btn btn-pause" onclick="bridge.pauseAllDownloads()" title="Pause All">
            <span class="material-icons">pause</span>
        </button>
        <button class="icon-action-btn btn-stop" onclick="bridge.stopAllDownloads()" title="Stop All">
            <span class="material-icons">stop</span>
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="downloads-container">
    <!-- Download Speed Graph -->
    <div class="service-card"
        style="margin-bottom: 1.5rem; padding: 1rem; height: 110px; position: relative; background: linear-gradient(180deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.2) 100%);">
        <div
            style="position: absolute; top: 0.75rem; left: 1rem; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-icons" style="font-size: 14px; color: rgb(var(--accent-500));">show_chart</span>
            Live Download Speed
        </div>
        <div
            style="position: absolute; top: 0.75rem; right: 1rem; display: flex; gap: 1rem; font-size: 0.7rem; font-weight: 700;">
            <div style="display: flex; align-items: center; gap: 0.4rem;">
                <span style="color: var(--text-muted);">CURRENT:</span>
                <span id="graph-current-speed" style="color: #3b82f6;">0 B/s</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.4rem;">
                <span style="color: var(--text-muted);">PEAK:</span>
                <span id="graph-peak-speed" style="color: #ef4444;">0 B/s</span>
            </div>
        </div>
        <canvas id="downloads-speed-graph" style="width: 100%; height: 100%;"></canvas>
    </div>

    <!-- Main List Card -->
    <div class="service-card" style="padding: 0; overflow: visible;">
        <div style="overflow-x: auto;">
            <table class="download-table">
                <thead>
                    <tr>
                        <th onclick="bridge.sortDownloads('name')" style="cursor: pointer;">
                            NAME <span class="material-icons" id="sort-icon-name"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('category')" style="cursor: pointer;">
                            CATEGORY <span class="material-icons" id="sort-icon-category"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('size')" style="cursor: pointer;">
                            SIZE <span class="material-icons" id="sort-icon-size"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('progress')" style="cursor: pointer; width: 180px;">
                            PROGRESS <span class="material-icons" id="sort-icon-progress"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('status')" style="cursor: pointer;">
                            STATUS <span class="material-icons" id="sort-icon-status"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('speed')" style="cursor: pointer;">
                            SPEED <span class="material-icons" id="sort-icon-speed"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th onclick="bridge.sortDownloads('eta')" style="cursor: pointer;">
                            ETA <span class="material-icons" id="sort-icon-eta"
                                style="font-size: 16px; vertical-align: middle; opacity: 0.5;">swap_vert</span>
                        </th>
                        <th style="text-align: right; padding-right: 1.5rem;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="downloads-full-list">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 5rem; color: var(--text-muted);">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                                <span class="material-icons"
                                    style="font-size: 3rem; opacity: 0.2;">cloud_download</span>
                                <div>Loading your download queue...</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="downloads-pagination" class="pagination-container"
            style="display: flex; align-items: center; justify-content: flex-end; gap: 1rem; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);">
            <span id="pagination-info" style="font-size: 0.85rem; color: var(--text-muted);">Showing 0-0 of 0</span>
            <div style="display: flex; gap: 0.5rem;">
                <button id="prev-page" class="icon-btn" onclick="bridge.changePage(-1)"
                    style="border: 1px solid var(--border-color); border-radius: 6px; padding: 4px;">
                    <span class="material-icons" style="font-size: 18px;">chevron_left</span>
                </button>
                <button id="next-page" class="icon-btn" onclick="bridge.changePage(1)"
                    style="border: 1px solid var(--border-color); border-radius: 6px; padding: 4px;">
                    <span class="material-icons" style="font-size: 18px;">chevron_right</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Add Link Modal -->
<div id="add-link-modal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center;">
    <div class="service-card"
        style="width: 100%; max-width: 500px; padding: 2rem; border-color: rgba(59, 130, 246, 0.3);">
        <div class="service-header" style="margin-bottom: 1.5rem;">
            <div class="service-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <span class="material-icons">add_link</span>
            </div>
            <div class="service-title">Add Fshare Link</div>
            <button onclick="bridge.hideAddModal()"
                style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer;">
                <span class="material-icons">close</span>
            </button>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <label
                style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 700;">Fshare
                URL</label>
            <input type="text" id="manual-link-input" class="elegant-search-input" style="padding-left: 1rem;"
                placeholder="https://www.fshare.vn/file/..." autofocus>
        </div>

        <div id="modal-error-msg"
            style="display: none; color: #ef4444; font-size: 0.85rem; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="font-size: 16px;">error_outline</span>
                <span id="error-text">Invalid link</span>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="bridge.hideAddModal()" class="icon-action-btn"
                style="width: auto; padding: 0 1.5rem; font-weight: 600; font-size: 0.85rem;">CANCEL</button>
            <button onclick="bridge.submitManualLink()" id="submit-link-btn" class="icon-action-btn"
                style="width: auto; padding: 0 1.5rem; background: #3b82f6; color: white; border: none; font-weight: 600; font-size: 0.85rem;">ADD
                TO QUEUE</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let speedChart = null;
    let speedChartActive = false;
    const maxPoints = 40;
    let peakSpeed = 0;

    function wakeupSpeedChart() {
        const ctx = document.getElementById('downloads-speed-graph');
        if (ctx) {
            // SPA Navigation check: if chart exists but linked to old canvas, destroy it
            if (speedChart && (speedChart.canvas !== ctx || !document.body.contains(speedChart.canvas))) {
                speedChart.destroy();
                speedChart = null;
            }

            if (!speedChart) {
                initSpeedGraph();
            }
            speedChartActive = true;
        } else {
            speedChartActive = false;
        }
    }

    function initDownloadsPage() {
        if (bridge) {
            bridge.currentPage = 1;
            bridge.itemsPerPage = 6;
            bridge.loadDownloads();

            // Initialize speed graph
            wakeupSpeedChart();
        }

        // Clean up any existing intervals to prevent leaks on tab switching
        if (window.downloadsRefreshInterval) clearInterval(window.downloadsRefreshInterval);
        if (window.speedGraphInterval) clearInterval(window.speedGraphInterval);

        // Download list refresh (2000ms)
        window.downloadsRefreshInterval = setInterval(() => {
            if (bridge) {
                bridge.loadDownloads();
            }
        }, 2000);

        // Speed graph refresh (250ms)
        window.speedGraphInterval = setInterval(() => {
            // Try to wake up if not active
            if (!speedChartActive) {
                wakeupSpeedChart();
            }
            if (speedChartActive) {
                updateSpeedGraph();
            }
        }, 250);
    }

    // Initialize immediately (handles both cold load and SPA navigation eval)
    initDownloadsPage();

    function initSpeedGraph() {
        const ctx = document.getElementById('downloads-speed-graph');
        if (!ctx) return;

        speedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(maxPoints).fill(''),
                datasets: [{
                    data: Array(maxPoints).fill(0),
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: (context) => {
                        const chart = context.chart;
                        const { ctx, chartArea } = chart;
                        if (!chartArea) return null;
                        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                        return gradient;
                    },
                    tension: 0.4,
                    pointRadius: 0,
                    pointHitRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    x: { display: false },
                    y: {
                        display: false,
                        beginAtZero: true,
                        suggestedMax: 1000000 // Start with 1MB/s scale
                    }
                },
                animation: { duration: 800 }
            }
        });
    }

    async function updateSpeedGraph() {
        if (!speedChart) return;

        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            const currentSpeed = data.pyload.speed_bytes || 0;
            const currentFormatted = data.pyload.speed || '0 B/s';

            if (currentSpeed > peakSpeed) {
                peakSpeed = currentSpeed;
                const peakLabel = document.getElementById('graph-peak-speed');
                if (peakLabel) peakLabel.textContent = currentFormatted;
            }

            const currentLabel = document.getElementById('graph-current-speed');
            if (currentLabel) currentLabel.textContent = currentFormatted;

            speedChart.data.datasets[0].data.shift();
            speedChart.data.datasets[0].data.push(currentSpeed);

            // Adjust max scale dynamically
            const maxVal = Math.max(...speedChart.data.datasets[0].data);
            if (maxVal > speedChart.options.scales.y.suggestedMax) {
                speedChart.options.scales.y.suggestedMax = maxVal * 1.2;
            }

            speedChart.update('none');
        } catch (e) {
            console.error("Failed to update speed graph:", e);
        }
    }
</script>
{% endblock %}